## Руководство по разметке GoodNotes/рукописных конспектов

Цель: стабильная тренировка детектора разметки и корректная маршрутизация блоков в последующие модули (HTR для рукописного текста, LaTeX-распознавание формул, хранение картинок, структура документа).

### Таксономия (6 классов)
- **handwriting_paragraph**: основной рукописный текст, читаемый линейно (абзацы, перечисления без визуального отделения заголовком).
- **handwriting_explanatory**: поясняющий рукописный текст, привязанный к другому объекту (стрелка/скобка/ярлык; сбоку/над/под объектом; на полях). Это не основной поток чтения.
- **handwriting_drawing**: рукописные схемы, оси, стрелки, фигуры, рамки, графики (не текст как основной контент).
- **inserted_image**: вставленные изображения (скриншоты, вырезки, фото, импортированные рисунки из других приложений).
- **formula**: самостоятельные математические выражения (блочные формулы), предназначенные для LaTeX/OCR формул.
- **heading**: отдельная строка‑заголовок (подчёркнутая/крупнее/жирная/строка‑«шапка» списка/буллет‑только‑строка).

Индексы классов фиксированы: 0..5 в порядке перечисления выше.

### Общие принципы
- **Размечаем блоки, а не отдельные строки** — но допускается разделять абзац на 2–3 бокса, если внутри есть «врезки» explanatory/формулы/рисунки.
- **Перекрытия:** стремимся минимизировать, но допускаем в реальных случаях (см. «Пересечения и вложенность» ниже). Критично не оставлять позитивы неразмеченными.
- **Страницу размечаем полностью по целевым классам**. Неразмеченный позитивный объект превращается в «фон» и портит обучение (снижает recall).
- **Приоритеты при конфликте (tie‑break):** formula > inserted_image > handwriting_drawing > heading > handwriting_explanatory > handwriting_paragraph.
- **Гранулярность:** не дробим на микротокены; держим логически цельные блоки.

### Пересечения и вложенность (важно)
- Если поверх картинки находятся рукописные подписи/стрелки:
  - Картинка — **inserted_image** (бокс может охватывать весь рисунок).
  - Подписи/стрелки — отдельные боксы **handwriting_explanatory** поверх картинки.
  - Перекрытие разных классов допустимо. Старайтесь держать перекрытие умеренным; ориентир: IoU между разными классами < 0.2, если можно.
- Если в абзац «врезан» explanatory (сбоку/сверху/внутри):
  - Предпочтительно разделить абзац на 2 бокса вокруг врезки, чтобы уменьшить перекрытие.
  - Если разделить некрасиво/неудобно — оставьте абзац одним боксом и добавьте отдельный бокс **handwriting_explanatory**, допустив небольшое перекрытие.
- Формула поверх картинки:
  - Если это **рукописная** формула поверх рисунка — отметьте **formula** поверх **inserted_image** (перекрытие допустимо).
  - Если это **напечатанная** формула как часть скриншота — помечаем только **inserted_image** (не дублируем formula внутри картинки).

### Критерии для пограничных случаев
- **formula vs handwriting_paragraph**
  - Преобладает математика (дроби, формульная верстка, матрицы, большие выражения) — это формульный блок → formula.
  - Встроенная формула внутри связного текста — остаётся paragraph; отдельно формулу НЕ выделяем.
  - Если формула занимает отдельную строку и визуально отделена — это formula; соседний текст — paragraph.
- **handwriting_explanatory vs handwriting_paragraph**
  - Текст не в основном потоке, а как подпись/комментарий/указатель к объекту (стрелка, фигурная скобка, подпись возле рисунка/формулы/абзаца) — explanatory.
  - Связный основной текст по ширине страницы/колонки без явной привязки к объекту — paragraph.
- **heading**
  - Отдельная строка с визуальными признаками заголовка (подчёркивание, большой/жирный шрифт, «шапка» списка) — heading (отдельный бокс).
  - Если признаков нет и строка является первой строкой обычного текста — это paragraph.
- **handwriting_drawing vs inserted_image**
  - Импортированный рисунок/скрин/фото — inserted_image.
  - Рукописные формы/оси/стрелки/рамки — handwriting_drawing.
  - Подписи к рисунку/схеме — как правило explanatory (если рядом и указывают на элемент).

### Кейсы и как размечать
1) **Смешанный текст с формулами в строке**
   - Пример: «a(x)=b лучше чем c(x)=d, но тем не менее x' = K».
   - Это одна связная мысль в одной строке/абзаце → **размечать одним handwriting_paragraph**, без отдельных боксов formula.
   - Если одна из формул стоит на отдельной строке как блочная (с пустыми полями сверху/снизу или большой высотой) — тогда эту строку как **formula**, остальной связный текст — **handwriting_paragraph**.

2) **Страница целиком занята формулой**
   - Это один крупный формульный блок → **formula** (один или несколько крупных боксов, если логически разделено).

3) **Абзац с несколькими отдельными блочными формулами**
   - Каждая блочная формула — отдельный **formula**.
   - Между ними связный текст — один или несколько **handwriting_paragraph** (по логическим блокам), без перекрытий.

4) **Заголовок и последующий текст/формула/картинка**
   - Заголовок — отдельный бокс **heading**.
   - Ниже: связный текст — **handwriting_paragraph**; формула — **formula**; картинка — **inserted_image**.

5) **Пояснения к объекту**
   - Подпись/стрелка/brace около формулы/рисунка/абзаца — **handwriting_explanatory** (отдельный бокс).
   - Не включайте сам целевой объект в бокс explanatory.

5a) **Explanatory на картинке**
   - Картинка — **inserted_image**.
   - Текстовые пояснения поверх — отдельные **handwriting_explanatory** (перекрытие допустимо).

6) **Списки/перечисления**
   - Заголовок списка (строка‑«шапка»/подчёркнутая/жирная/буллет‑только) — **heading**.
   - Пункты списка (обычные строки) — **handwriting_paragraph** (можно одним общим боксом, если это один компактный блок).

7) **Рисунки с подписями**
   - Контур/эскиз/ось/фигура — **handwriting_drawing**.
   - Подписи‑ярлыки к частям рисунка — **handwriting_explanatory**.
   - Не создавайте один огромный бокс, перекрывающий и рисунок, и подписи вместе — держите раздельно (перекрытия допустимы, но не сливайте классы).

8) **Табличный вид**
   - Отдельного класса «table» нет. Если таблица **вставлена** как картинка — **inserted_image**.
   - Если сетка **рукописная** — сетка как **handwriting_drawing**; текст внутри клеток — обычно **handwriting_paragraph** (по блокам, не по каждой ячейке, без перекрытий).

### Границы боксов
- Держите бокс с небольшим запасом по краям (2–6 px при 400 DPI), но **не захватывайте** соседние блоки.
- Не дробите на микробоксы слова/символы — используем блоки уровня абзацев/формул/рисунков.

### Контроль качества разметки
- Страница в выборке train должна быть **полностью** размечена по целевым классам; незамеченные позитивы ухудшают обучение.
- Для балансировки классов выбирайте страницы, где нужный класс встречается чаще (а не пропускайте экземпляры на текущей странице).
- Проверяйте, что **heading** выделен отдельно, а не «слит» с абзацем.
- Формулы блочные — отдельные боксы **formula**; формулы «в тексте» — остаются в **handwriting_paragraph**.

### Мини‑чеклист перед сохранением
- Блоки без перекрытий? Да/нет.
- Все позитивы, относящиеся к целевым классам, размечены? Да/нет.
- Заголовки отделены? Да/нет.
- Блочные формулы выделены как formula, inline‑формулы остались в paragraph? Да/нет.
- Пояснения (стрелки/скобки/подписи) — отдельные explanatory? Да/нет.

### Часто задаваемые вопросы
- «Если в строке есть и текст, и короткие формулы — это formula?» — Нет, это **handwriting_paragraph**.
- «Можно ли объединять несколько близких формул в один бокс?» — Да, если они логически один блок; иначе раздельно.
- «Если у блока есть и текст, и рисунок внутри?» — Разделяйте: текст как paragraph/explanatory, рисунок как drawing; не перекрывайте.

### Замечания по данным
- Текущая таксономия фиксирована: 6 классов. Не используйте другие названия.
- Файл аннотаций хранит `category_id` в диапазоне 0..5 согласно порядку классов в этом документе.

### Итог по примеру
Фраза: «a(x)=b лучше чем c(x)=d, но тем не менее x' = K» — **один бокс handwriting_paragraph**. Если же одна/несколько формул стоят **на отдельных строках** и визуально отделены, эти строки — **formula**, остальное — **handwriting_paragraph**.


